---
title: Uniswap v3中的無常損失(3)：無常損失細探
img: 922/6v2E92.jpg
tags: [DeFi, 投資, 流動性挖礦, 加密貨幣, uniswap v3, uniswap]
category: life
---

此系列文章翻譯自 Topaze Blue 和 Bancor Protocol 在 2021 年 11 月 17 日發布的一份報告：[《Impermanent Loss in Uniswap v3》](https://arxiv.org/pdf/2111.09192.pdf)。作者分別為：

- [Stefan Loesch](mailto:stefan@topaze.blue)
- [Nate Hindman](mailto:nate@bancor.network)
- [Nicholas Welch](mailto:nick@bancor.network)
- [Mark B. Richardson](mailto:mark@bancor.network)

<!--more-->

譯文中會穿插自己看不懂而上網查到的專有名詞解釋或是筆記，請斟酌服用。

---

## Uniswap v3 中的無常損失

### 簡介

Uniswap v3 的公式相對複雜，我們嘗試架構出一個理論，以說明其基本原理其實相對簡單。

首先，Uniswap 開發者提出了一個關鍵概念：透過強制停止交易來限制自動市場做市商（AMM）的交易範圍。

假設 𝑥 幣種剛開始的價值為 100 美元，並且 AMM 強制在其 𝑥 超出 80 到 120 的範圍時停止交易。我們知道，當下跌至 80（跌 20%）時，無常損失是`(1 + 0.8 − √0.8) / 2`約等於 0.56%；而在上漲時，無常損失則是`(1 + 1.2 − √1.2) / 2`約等於 0.46%。

我們知道，在該範圍內的任何地方（包含上下限），x 與美元的組成價值是一樣的。因此在下限時，每單位的 x 會有對應的 80 美元，在上限時則是 120。而當價格低於 80 或高於 120 時，AMM 會停止交易，因此從這個觀點出發，不論價格變動如何，投資組合的比例（但不是其價值）保持不變。

從傳統的 AMM 角度看，這將無常損失限制在約 0.5%。然而現在多了超出流動性範圍的問題，正如我們下面將看到的，這會是對於範圍在 80 ~ 120 的流動性最直觀且影響最大的部份。而這部份很容易理解：我們已經看到在 80 到 120 之間，無常損失會在 0.6%以內。看起來不錯，但在這個範圍之外呢？我們的初始投資組合是每單位 x 有 100 美元。在低於下限時，投資組合是靜態的，但每單位 x 有 80 美元。換句話說：AMM 對 x 的曝險比 HODL 投資組合更多（AMM 低買高賣），如果 x 進一步下跌，AMM 將遭受更大的損失。

<article-note>此段文章中，作者使用的名詞是「風險資產（risk asset）」以及「計價資產（numeraire）」，為了方便理解，此處將其代換成最初舉例中的 x 及美元。</article-note>

這種隨著漲跌的損失是真實的，但它在結構上不同於我們平常所說的無常損失，因此我們在這裡做出了一個重要的區分：

- **必要的無常損失**：資產在範圍內時所產生的無常損失，即使是最複雜的交易者也無法避免——只要他們想賺取費用，這就是他們面臨的風險。
- **範圍外的無常損失**：在資產價值超出流動性範圍時產生的無常損失。這是初始 HODL 價格與流動性範圍末端價格位置之間的表現差異，當流動性處於這些位置時為過度被換成表現不佳的資產。範圍外的無常損失可以透過在流動性超出範圍後撤回倉位並將其重新平衡到初始 HODL 組合中來避免，或者重新平衡到任何流動性提供者（LP）偏好的任何方向性倉位中，且不會產生費用損失。
- **真實無常損失**：為上述兩項無常損失的總和。

我們認為真實無常損失是我們分析中最重要的無常損失，因為我們想了解流動性提供者在 Uniswap v3 上的真實表現。這意味著我們需要涵蓋所有產生的損失，即使這些損失本可以被更精明的投資者避免，這些投資者有能力在超出範圍時重新平衡他們的倉位。

目前為止，我們將交易範圍限制在 80 到 120 來降低傳統 AMM 的風險。然而，這還有另一個前提：因為我們限制了交易範圍，所以池子中組成資產的數量下降也有一定的限度。在下跌趨勢中，AMM 會購買風險資產並賣出計價資產，因此計價資產的最低持有量在我們的假設下是在價格為 80 時。我們知道在 80 時投資組合的價值是 `200√0.8`，我們知道其中 50% 是計價資產。換句話說，在 80 到 120 的 AMM 中，計價資產的最低持有量是 `100√0.8`，約等於 89。與其說是投入了價值 100 美元的計價資產，不如說我們其實是投入 11 美元，因為這是我們可能承受的最大損失。

> 這就是槓桿 AMM 的基本原理：我們只貢獻了 11 個單位的計價資產，但我們的 AMM 表現得就像它擁有價值 100 個單位的流動性。若以跌至 80 的角度來看，這在我們投入的計價資產上提供了大約 9 倍的槓桿。

在上漲方面的計算也差不多，我們只需要考慮計價資產的影響。在 120 時，AMM 投資組合的價值是 `200√1.2`，其中一半仍然是計價資產，因此我們有 `100√1.2`，約等於 109.5 單位的計價資產投資於風險資產。我們也知道，在邊界處，1 單位的風險資產價值是 120 單位的計價資產，因此以風險資產計算，我們的持有量是 109.5/120 = 0.91。換句話說，我們可以說我們投入了 0.09 單位的風險資產，而不是 1 單位，這相當於 11 倍的槓桿。

這裡要注意的是，上漲和下跌的槓桿數字並不相同，而且貢獻資產的價值也不再相同：我們需要 11 個單位的計價資產和 0.09 個單位的風險資產，這在價格為 100 時對應的價值是 9。這是因為從乘法角度看，我們的範圍是不對稱的。

如果我們使用明顯不對稱的範圍，例如 80 到 140，這種效應會更加明顯。在這種情況下，下限不變，但在上限，我們有(100√1.4) / 140 ≈ 0.85。在這種情況下，我們仍然需要 11 個單位的計價資產，但由於上限範圍更寬，我們一開始需要價值 15 個單位計價資產的風險資產。相反，如果我們將上限限制在 110，我們得到(100√1.1) / 110 ≈ 0.95，所以我們只需要使用價值 5 個單位計價資產的風險資產。

現在，從另個角度來看，需要使用較少的抵押品是有利的：假設我們能貢獻的抵押品數量有限，槓桿 AMM 允許我們建立更大的虛擬流動性池，因此具有較低的滑點並希望能吸引更多的交易，從而賺取更多的費用。

然而不利的是，這種放大效應也放大了無常損失。以 80 到 120 的範圍為例，初始的無常損失是未槓桿池帳面價值的 0.5%。在這個範圍內，我們的最大槓桿大約是 10 倍，這意味著我們的最大損失率突然增加了同樣的倍數，達到 5%。對於更明顯的不對稱範圍，我們需要區分上漲和下跌的無常損失。

---

### Uniswap v3 投資組合的價值與結構

Uniswap v3 AMM 投資組合的價值更加複雜。例如，Lambert 提供了一個很好的概述，說明如何計算這個價值。使用與 Lambert 稍有不同的符號，我們發現 Uniswap v3 位置的投資組合價值 AMM(𝑥) 為：

<article-img img="923/8b6YhO.png" aspect-ratio="780 / 225"></article-img>

其中 𝑥 是池中兩種資產的價格比率，𝑥<sub>0</sub>和 𝑥<sub>1</sub>分別是提供流動性的範圍的下限和上限，而 𝑛<sub>1</sub>是整體投資組合名義價值因子。我們繪製了這個函數在三個不同範圍內的圖，範圍的下限分別是 𝑥 = 70、80、90，上限則選擇使範圍在乘法上對稱於 100 的值。

<article-img img="924/aOMQmO.png" aspect-ratio="1637 / 1092"></article-img>

我們看到，當 𝑥 < 𝑥<sub>0</sub> ​ 時，圖表在 𝑥 上是線性的，這意味著倉位完全投資於風險資產，這正如我們在風險資產下行時所預期的那樣。當 𝑥 > 𝑥<sub>1</sub> ​ 時，曲線是常數，這意味著倉位完全投資於計價資產，這也正如我們在風險資產上行時所預期的那樣。
