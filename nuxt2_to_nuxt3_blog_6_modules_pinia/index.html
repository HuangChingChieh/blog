<!DOCTYPE html><html lang="zh-Hant-TW" data-bs-theme="dark"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>部落格Nuxt 2升級Nuxt 3（六）：Vuex → Pinia｜隨機手札</title>
<script async defer src="https://www.googletagmanager.com/gtag/js?id=G-KHMFPTGCC2"></script>
<script>window.dataLayer = window.dataLayer || []
          function gtag() {
            dataLayer.push(arguments)
          }
          gtag('js', new Date())
    
          gtag('config', 'G-KHMFPTGCC2')</script>
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="format-detection" content="telephone=no">
<meta property="og:site_name" content="隨機手札">
<meta property="og:locale" content="zh_TW">
<meta name="apple-mobile-web-app-title" content="隨機手札">
<link rel="icon" href="https://huangchingchieh.github.io/blog/favicon.ico">
<link rel="apple-touch-icon" href="https://huangchingchieh.github.io/blog//pwa-192x192.png">
<link rel="mask-icon" href="https://huangchingchieh.github.io/blog//maskable-icon-512x512.png">
<link rel="manifest" href="/blog/manifest.webmanifest">
<meta name="description" content="Nuxt 3 的狀態管理套件從 Nuxt 2 的 Vuex 改成了 Pinia，兩者差異不算大，部落格用到的功能也不多。其中比較要注意的就是 Nuxt 3 不再提供nuxtServerInit方法，若需要在 server 端初始化一些資料的話，就要透過其他作法來完成。">
<meta property="og:url" content="https://huangchingchieh.github.io/blog/nuxt2_to_nuxt3_blog_6_modules_pinia/">
<meta property="og:type" content="article">
<meta property="og:title" content="部落格Nuxt 2升級Nuxt 3（六）：Vuex → Pinia">
<meta property="og:description" content="Nuxt 3 的狀態管理套件從 Nuxt 2 的 Vuex 改成了 Pinia，兩者差異不算大，部落格用到的功能也不多。其中比較要注意的就是 Nuxt 3 不再提供nuxtServerInit方法，若需要在 server 端初始化一些資料的話，就要透過其他作法來完成。">
<meta property="og:image" content="https://imagizer.imageshack.com/v2/1600x1200q100/924/Ia2nWi.png">
<meta property="og:article:published_time" content="2024-01-24T07:26:04.000Z">
<meta property="og:article:modified_time" content="2024-01-24T07:26:04.000Z">
<meta property="og:article:tag" content="blog">
<meta property="og:article:tag" content="nuxt">
<meta property="og:article:tag" content="vue">
<meta property="og:article:tag" content="nuxt2">
<meta property="og:article:tag" content="nuxt3">
<meta property="og:article:tag" content="vuex">
<meta property="og:article:tag" content="pinia">
<script type="application/ld+json" json="[object Object]"></script>
<link rel="preload" as="image" imagesizes="(min-width: 992px) 800px,(min-width: 768px) 640px,640px" data-hid="22f22ce">
<link rel="preload" as="fetch" crossorigin="anonymous" href="/blog/nuxt2_to_nuxt3_blog_6_modules_pinia/_payload.json">
<link rel="stylesheet" href="/blog/_nuxt/entry.M5dRi2JB.css">
<link rel="stylesheet" href="/blog/_nuxt/default.dOUfyJxr.css">
<link rel="stylesheet" href="/blog/_nuxt/_slug_.i35pAZTR.css">
<link rel="stylesheet" href="/blog/_nuxt/article-code.07oCiPBg.css">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/entry.p-R_Zo4F.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/default.OWgiRqUk.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/index.gfxTODMy.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/interface-button.VPKuH5Rr.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/interface-modal.9fFWHp0l.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/_commonjsHelpers.5-cIlDoe.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/bVisible.XJbmSgc8.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/common-outer-link.XYcJnsU4.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/_slug_.39KEfZ2e.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ContentRenderer.MN4kcdeJ.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ContentRendererMarkdown.vue.IADV500u.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/index.1dSrIji7.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ContentRendererMarkdown.BsKkxfze.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseP.qJEDH6aM.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/article-outer-link.Uk51PIWu.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseCodeInline.CLBBeKNV.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseHr.FEyECxDi.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseH2.3F484H-M.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseUl.1Ly1AEAM.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseLi.-1ZA8jyw.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/article-code.w7s2-6gj.js">
<link rel="modulepreload" as="script" crossorigin href="/blog/_nuxt/ProseBlockquote.-AIxbYyo.js">
<link rel="prefetch" as="script" crossorigin href="/blog/_nuxt/workbox-window.prod.es5.prqDwDSL.js">
<link rel="prefetch" as="script" crossorigin href="/blog/_nuxt/client-db.UiF7r9Bx.js">
<link rel="prefetch" as="script" crossorigin href="/blog/_nuxt/scrollspy.6oqBaYZn.js">
<link rel="prefetch" as="script" crossorigin href="/blog/_nuxt/selector-engine.hD3Xzbi-.js">
<script type="module" src="/blog/_nuxt/entry.p-R_Zo4F.js" crossorigin></script>
<script id="unhead:payload" type="application/json">{"titleTemplate":"%s｜隨機手札"}</script></head><body><div style="position:fixed;"></div><!--teleport anchor--><div tabindex="-1" aria-hidden="true" class="modal fade"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><div class="modal-title h5">文章分類</div><button type="button" class="btn-close" aria-label="關閉"></button></div><div class="modal-body"><!--[--><ul class="nav flex-column"><!--[--><li class="nav-item"><a href="/blog/category/all/1/" class="nav-link"><!--[-->最新文章<!--]--></a></li><li class="nav-item"><a href="/blog/category/linux/1/" class="nav-link"><!--[-->Linux心得<!--]--></a></li><li class="nav-item"><a href="/blog/category/frontend/1/" class="nav-link"><!--[-->前端筆記<!--]--></a></li><li class="nav-item"><a href="/blog/category/life/1/" class="nav-link"><!--[-->生活雜記<!--]--></a></li><!--]--></ul><!--]--></div></div></div></div><!--teleport anchor--><div tabindex="-1" aria-hidden="true" class="modal fade"><div class="modal-lg modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><div class="modal-title h5">搜尋文章</div><button type="button" class="btn-close" aria-label="關閉"></button></div><div class="modal-body"><!--[--><div class="d-flex flex-column"><div class="_inputGroup_11kzr_8 position-relative"><input value placeholder="請輸入關鍵字" type="text" class="form-control _input_11kzr_8"><div class="_iconWrapper_11kzr_11 d-flex align-items-center justify-content-center px-3"><i class="bi-search _icon_11kzr_11"></i></div></div><div class="_results_11kzr_2 mt-3"><!----></div></div><!--]--></div></div></div></div><!--teleport anchor--><div id="__nuxt"><!--[--><!----><!--[--><header class="pt-sm-4 _header_1ae6h_2"><div class="container container-sm py-sm-3 d-flex flex-row align-items-center"><!--[--><img src="/blog/pwa-64x64.png" height="64" width="64" class="common-icon rounded-circle shadow-sm bordered _bordered_t6qrn_2 _logo_1ae6h_21"><div class="ms-3 flex-grow-1"><a href="/blog/" class="fw-bold text-body d-block text-decoration-none"> 隨機手札 </a><small class="text-muted d-none d-sm-block">雜七雜八之地</small></div><div class="d-flex align-items-center justify-content-end"><div><button class="btn-link btn d-flex align-items-center text-decoration-none ms-4 _icon_1ae6h_25 d-flex" type="button" title="文章分類"><!--[--><i class="bi-folder h5 mb-0 d-flex"></i><!--[--><!--]--><!--]--></button><!--teleport start--><!--teleport end--></div><div><span></span></div><button class="btn-link btn d-flex align-items-center text-decoration-none ms-4 _icon_1ae6h_25 d-flex" type="button"><!--[--><i class="bi-moon-stars h5 mb-0 d-flex"></i><!--[--><!--]--><!--]--></button><div><button class="btn-link btn d-flex align-items-center text-decoration-none ms-4 _icon_1ae6h_25 d-flex" type="button" title="搜尋文章"><!--[--><i class="bi-search h5 mb-0 d-flex"></i><!--[--><!--]--><!--]--></button><!--teleport start--><!--teleport end--></div></div><!--]--></div><div></div></header><main class="container container-sm py-4"><!--[--><!--[--><div><div class="p-sm-5 _container_1s3jf_3"><!--[--><article class="_article_13yi1_2"><h1 class="_title_13yi1_5">部落格Nuxt 2升級Nuxt 3（六）：Vuex → Pinia</h1><div class="d-flex flex-row align-items-center my-2"><time class="d-flex align-items-center flex-row text-muted small mb-0 _date_13yi1_10"><!--[--><i class="bi-calendar-event me-1"></i><span class="me-3">2024/01/24</span><!--]--></time><span class="text-muted small d-inline-flex align-items-center"><i class="bi-clock me-1"></i><span class="me-3">5 min</span></span><a href="/blog/category/frontend/1/" class="text-muted small d-inline-flex align-items-center"><i class="bi-folder me-1"></i><span>前端筆記</span></a></div><div class="_tags_13yi1_13 d-flex flex-wrap my-2"><!--[--><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->blog<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->nuxt<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->vue<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->nuxt2<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->nuxt3<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->vuex<!--]--><!--]--></span><span class="badge bg-secondary text-bg-secondary d-inline-block fw-normal font-monospace me-1 mb-1"><!--[--> #<!--[-->pinia<!--]--><!--]--></span><!--]--></div><div class="position-relative rounded _banner_13yi1_16"><img srcset="https://imagizer.imageshack.com/v2/100x75q70/924/Ia2nWi.png 100w, https://imagizer.imageshack.com/v2/150x100q70/924/Ia2nWi.png 150w, https://imagizer.imageshack.com/v2/280x200q70/924/Ia2nWi.png 280w, https://imagizer.imageshack.com/v2/320x240q70/924/Ia2nWi.png 320w, https://imagizer.imageshack.com/v2/640x480q70/924/Ia2nWi.png 640w, https://imagizer.imageshack.com/v2/800x600q70/924/Ia2nWi.png 800w, https://imagizer.imageshack.com/v2/1024x768q70/924/Ia2nWi.png 1024w, https://imagizer.imageshack.com/v2/1280x1024q70/924/Ia2nWi.png 1280w, https://imagizer.imageshack.com/v2/1600x1200q70/924/Ia2nWi.png 1600w" src="https://imagizer.imageshack.com/v2/924/Ia2nWi.png" class="_img_5u372_2 rounded" loading="lazy"></div><div class="nuxt-content"><p><!--[--><a href="https://nuxt.com/docs/getting-started/state-management#using-third-party-libraries" target="_blank" rel="noopener noreferrer nofollow"><!--[--><!--[-->Nuxt 3 的狀態管理套件從 Nuxt 2 的 Vuex 改成了 Pinia<!--]--><!--]--></a>，兩者差異不算大，部落格用到的功能也不多。其中比較要注意的就是 Nuxt 3 不再提供<code class=""><!--[-->nuxtServerInit<!--]--></code>方法，若需要在 server 端初始化一些資料的話，就要透過其他作法來完成。<!--]--></p><p><!--[-->本來以為升級起來不會太困難，但踩了個小坑……。<!--]--></p><hr><h2 id="寫法差異"><!--[-->寫法差異<!--]--></h2><p><!--[-->這部份因為滿容易的，這邊僅列出官方文章做個參考紀錄：<!--]--></p><ul><!--[--><li><!--[--><a href="https://pinia.vuejs.org/ssr/nuxt.html" target="_blank" rel="noopener noreferrer nofollow"><!--[--><!--[-->Nuxt.js 整合指引<!--]--><!--]--></a><!--]--></li><li><!--[--><a href="https://pinia.vuejs.org/cookbook/migration-vuex.html" target="_blank" rel="noopener noreferrer nofollow"><!--[--><!--[-->Migrating from Vuex ≤ 4<!--]--><!--]--></a><!--]--></li><!--]--></ul><hr><h2 id="實作-nuxtserverinit"><!--[-->實作 nuxtServerInit<!--]--></h2><p><!--[-->之前在 Nuxt 2 中使用<code class=""><!--[-->nuxtServerInit<!--]--></code>，是因為我會在此處先處理並紀錄一些 metada（例如各分類的文章數量與頁數）以供元件使用，Nuxt 3 並無提供此方式，參考網路上文章之後可以透過「只在 server 端執行的<code class=""><!--[-->plugins<!--]--></code>」來完成：<!--]--></p><p><!--[-->首先在主要的<code class=""><!--[-->store<!--]--></code>下新增<code class=""><!--[-->index.js<!--]--></code>：<!--]--></p><div class="position-relative language-js shiki shiki-themes github-dark" code="import { defineStore } from &#39;pinia&#39;

import { getCategories, setPageCount } from &#39;~/utils/getCategories&#39;
import getTags from &#39;~/utils/getTags&#39;

export const useMainStore = defineStore(&#39;main&#39;, {
  state: () =&gt; ({
    someState: &#39;&#39;,
  }),
  actions: {
    nuxtServerInit() {
      // 這邊做原本nuxtServerInit要做的事
    },
  },
})
" meta style=""><div class="d-flex flex-row align-items-center text-white py-2 px-3 rounded-top bg-secondary"><div class="flex-grow-1 text-truncate pe-3 small fw-bold font-monospace">store/index.js</div><button class="btn-link btn p-0 d-flex align-items-center justify-content-center text-white" type="button"><!--[--><i class="bi-clipboard"></i><!--]--></button></div><div class="rounded-bottom bg-black"><pre class="_code_bvtnx_2"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { defineStore } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;pinia&#39;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { getCategories, setPageCount } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;~/utils/getCategories&#39;
</span></span><span class="line" line="4"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> getTags </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;~/utils/getTags&#39;
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">export</span><span style="--shiki-default:#F97583"> const</span><span style="--shiki-default:#79B8FF"> useMainStore</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#B392F0"> defineStore</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&#39;main&#39;</span><span style="--shiki-default:#E1E4E8">, {
</span></span><span class="line" line="7"><span style="--shiki-default:#B392F0">  state</span><span style="--shiki-default:#E1E4E8">: () </span><span style="--shiki-default:#F97583">=&gt;</span><span style="--shiki-default:#E1E4E8"> ({
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">    someState: </span><span style="--shiki-default:#9ECBFF">&#39;&#39;</span><span style="--shiki-default:#E1E4E8">,
</span></span><span class="line" line="9"><span style="--shiki-default:#E1E4E8">  }),
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8">  actions: {
</span></span><span class="line" line="11"><span style="--shiki-default:#B392F0">    nuxtServerInit</span><span style="--shiki-default:#E1E4E8">() {
</span></span><span class="line" line="12"><span style="--shiki-default:#6A737D">      // 這邊做原本nuxtServerInit要做的事
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">    },
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">  },
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">})
</span></span></code><!--]--></pre></div></div><p><!--[-->接著新增只在 server 端執行的 plugin，可以在命名後加上後綴字<code class=""><!--[-->.server.js<!--]--></code>來標明：<!--]--></p><div class="position-relative language-js shiki shiki-themes github-dark" code="import { useMainStore } from &#39;~/store&#39;

export default defineNuxtPlugin(async ({ $pinia }) =&gt; {
  const someAsyncData = await someAsyncFn()

  // 這邊引用前段宣告的store，記得要把context的$pinia傳進去。
  // 可參考：https://pinia.vuejs.org/ssr/nuxt.html#Awaiting-for-actions-in-pages
  const mainStore = useMainStore($pinia)
  mainStore.nuxtServerInit()
})
" meta style=""><div class="d-flex flex-row align-items-center text-white py-2 px-3 rounded-top bg-secondary"><div class="flex-grow-1 text-truncate pe-3 small fw-bold font-monospace">plugins/init.server.js</div><button class="btn-link btn p-0 d-flex align-items-center justify-content-center text-white" type="button"><!--[--><i class="bi-clipboard"></i><!--]--></button></div><div class="rounded-bottom bg-black"><pre class="_code_bvtnx_2"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { useMainStore } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;~/store&#39;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">export</span><span style="--shiki-default:#F97583"> default</span><span style="--shiki-default:#B392F0"> defineNuxtPlugin</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#E1E4E8"> ({ </span><span style="--shiki-default:#FFAB70">$pinia</span><span style="--shiki-default:#E1E4E8"> }) </span><span style="--shiki-default:#F97583">=&gt;</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#F97583">  const</span><span style="--shiki-default:#79B8FF"> someAsyncData</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#B392F0"> someAsyncFn</span><span style="--shiki-default:#E1E4E8">()
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span style="--shiki-default:#6A737D">  // 這邊引用前段宣告的store，記得要把context的$pinia傳進去。
</span></span><span class="line" line="7"><span style="--shiki-default:#6A737D">  // 可參考：https://pinia.vuejs.org/ssr/nuxt.html#Awaiting-for-actions-in-pages
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">  const</span><span style="--shiki-default:#79B8FF"> mainStore</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#B392F0"> useMainStore</span><span style="--shiki-default:#E1E4E8">($pinia)
</span></span><span class="line" line="9"><span style="--shiki-default:#E1E4E8">  mainStore.</span><span style="--shiki-default:#B392F0">nuxtServerInit</span><span style="--shiki-default:#E1E4E8">()
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8">})
</span></span></code><!--]--></pre></div></div><p><!--[-->這樣就完成囉。<!--]--></p><hr><h2 id="在-ssr-端修改-state-的眉角"><!--[-->在 SSR 端修改 state 的眉角<!--]--></h2><p><!--[-->這中間踩了一個坑，本來以為是 Bug 但其實不是。<!--]--></p><p><!--[-->總之是這樣的，我在頁面中去修改了某個在 store 中的屬性，而在 layout 中順序比<code class=""><!--[-->&lt;slot /&gt;<!--]--></code>（也就是<code class=""><!--[-->&lt;NuxtPage /&gt;<!--]--></code>的置入點）前面的元件，若依賴了這個屬性去做<code class=""><!--[-->v-if<!--]--></code>的顯示，則會在直接進入頁面時出現<code class=""><!--[-->Hydration node mismatch<!--]--></code>的警告，暗示我 server 端與 client 端的元件長得不一樣（也就是資料不一致）。<!--]--></p><div class="position-relative language-vue shiki shiki-themes github-dark" code="&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 這裡面有個元素依賴了store的state切換顯示 --&gt;
    &lt;!-- TestHeader會出現Hydration node mismatch的問題 --&gt;
    &lt;TestHeader /&gt;

    &lt;!-- 我在頁面元件中修改了store的state --&gt;
    &lt;NuxtPage /&gt;

    &lt;!-- 放在NuxtPage後面的TestFooter不會出現同樣問題 --&gt;
    &lt;TestFooter /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import TestHeader from &#39;~/components/test-header.vue&#39;
import TestFooter from &#39;~/components/test-footer.vue&#39;
&lt;/script&gt;
" meta style=""><div class="d-flex flex-row align-items-center text-white py-2 px-3 rounded-top bg-secondary"><div class="flex-grow-1 text-truncate pe-3 small fw-bold font-monospace">layouts/default.vue</div><button class="btn-link btn p-0 d-flex align-items-center justify-content-center text-white" type="button"><!--[--><i class="bi-clipboard"></i><!--]--></button></div><div class="rounded-bottom bg-black"><pre class="_code_bvtnx_2"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#E1E4E8">&lt;</span><span style="--shiki-default:#85E89D">template</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">  &lt;</span><span style="--shiki-default:#85E89D">div</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span><span class="line" line="3"><span style="--shiki-default:#6A737D">    &lt;!-- 這裡面有個元素依賴了store的state切換顯示 --&gt;
</span></span><span class="line" line="4"><span style="--shiki-default:#6A737D">    &lt;!-- TestHeader會出現Hydration node mismatch的問題 --&gt;
</span></span><span class="line" line="5"><span style="--shiki-default:#E1E4E8">    &lt;</span><span style="--shiki-default:#FDAEB7;--shiki-default-font-style:italic">TestHeader</span><span style="--shiki-default:#E1E4E8"> /&gt;
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-default:#6A737D">    &lt;!-- 我在頁面元件中修改了store的state --&gt;
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">    &lt;</span><span style="--shiki-default:#FDAEB7;--shiki-default-font-style:italic">NuxtPage</span><span style="--shiki-default:#E1E4E8"> /&gt;
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#6A737D">    &lt;!-- 放在NuxtPage後面的TestFooter不會出現同樣問題 --&gt;
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">    &lt;</span><span style="--shiki-default:#FDAEB7;--shiki-default-font-style:italic">TestFooter</span><span style="--shiki-default:#E1E4E8"> /&gt;
</span></span><span class="line" line="12"><span style="--shiki-default:#E1E4E8">  &lt;/</span><span style="--shiki-default:#85E89D">div</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">&lt;/</span><span style="--shiki-default:#85E89D">template</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">&lt;</span><span style="--shiki-default:#85E89D">script</span><span style="--shiki-default:#B392F0"> setup</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> TestHeader </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;~/components/test-header.vue&#39;
</span></span><span class="line" line="17"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> TestFooter </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &#39;~/components/test-footer.vue&#39;
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">&lt;/</span><span style="--shiki-default:#85E89D">script</span><span style="--shiki-default:#E1E4E8">&gt;
</span></span></code><!--]--></pre></div></div><p><!--[-->幾經測試之後，發現好像是元件解析順序的問題，也在 Nuxt Github 的 Discussions 裡面有發現<a href="https://github.com/nuxt/nuxt/discussions/17011" target="_blank" rel="noopener noreferrer nofollow"><!--[--><!--[-->相關討論<!--]--><!--]--></a>：<!--]--></p><blockquote><!--[--><p><!--[-->This is a common SSR gotcha. The issue is that on SSR, Vue renders the HTML from top to bottom, outside to inside. And if you only fetch some data as you are rendering the &#39;inner&#39; part of the page, it doesn&#39;t rerender the layout at the top of the page. (On client-side it&#39;s fine as can be reactive.) So if you have a common piece you rely on for rendering your page, make sure to fetch it in the layout, a plugin, or a middleware - somewhere outside of the rendering process.<!--]--></p><!--]--></blockquote><p><!--[-->沒錯，如 Nuxt 團隊的領導人所說：這是一個「common SSR gotcha」（常見的 SSR 問題），無法被解決，只能在開發時自己小心了（是說 Nuxt 2 沒這問題呀……還是只是沒 WARN 而已？）。<!--]--></p><p><!--[-->目前因為是 SEO 不敏感的區塊所以還好，解法是直接先把那一個區塊用<code class=""><!--[-->&lt;ClientOnly&gt;<!--]--></code>包起來，只是未來若遇到這樣的情境，而區塊剛好是 SEO 敏感的區塊……可能就要想想怎麼做了。<!--]--></p><hr><h2 id="後記"><!--[-->後記<!--]--></h2><p><!--[-->大概是這樣，只能說 Nuxt 2 升 3 的坑其實不少啊……（顯示為精疲力盡）。<!--]--></p><style>html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}</style></div></article><!--]--></div><hr class="d-sm-none d-block"><a href="https://ko-fi.com/chaoschaoshuang" target="_blank" rel="noopener noreferrer " class="mt-5 d-flex justify-content-center"><!--[--><img src="/blog/images/donation/kofi_button_blue.png" alt="Support me on Ko-fi" class="img-fluid d-block" width="200"><!--]--></a><div class="giscus mt-5"></div><div class="mt-5"><div class="h5 mb-4 text-center"> 相關文章 </div><!--[--><article class="d-flex flex-column align-items-stretch rounded flex-sm-row _card_iqejw_2 mt-3"><div class="order-sm-1 px-sm-4 d-flex flex-column flex-grow-1 px-3 py-3 order-2"><div class="_content_iqejw_30"><h4 class="_title_iqejw_30 text-body text-line-2">部落格Nuxt 2升級Nuxt 3（五）：Sitemap模組升級</h4><p class="_description_iqejw_24 text-muted text-line-2" title="原本使用的 Sitemap 模組 @nuxtjs/sitemap 有支援 Nuxt 3 的版本，所以升級起來不如前面幾篇困難，主要就是修改一下設定值而已。">原本使用的 Sitemap 模組 @nuxtjs/sitemap 有支援 Nuxt 3 的版本，所以升級起來不如前面幾篇困難，主要就是修改一下設定值而已。</p></div><div class="mt-sm-3 d-flex flex-row align-items-center"><time class="d-flex align-items-center flex-row text-muted small mb-0 small"><!--[--><i class="bi-calendar-event me-1"></i><span class="me-3">2024/01/24</span><!--]--></time><span class="text-muted small d-inline-flex align-items-center"><i class="bi-clock me-1"></i><span class="me-3">2 min</span></span><!----><div class="text-end flex-grow-1"><a href="/blog/nuxt2_to_nuxt3_blog_5_modules_sitemap/" class="btn-primary btn-sm btn d-inline-flex flex-row align-items-center _btn_1w7mw_2"><!--[--><!--[--> 閱讀更多 <!--]--><i class="bi-arrow-right _icon_1w7mw_2"></i><!--]--></a></div></div></div><div class="position-relative align-self-stretch order-1 order-sm-2 _banner_iqejw_20"><img srcset="https://imagizer.imageshack.com/v2/100x75q70/924/Ia2nWi.png 100w, https://imagizer.imageshack.com/v2/150x100q70/924/Ia2nWi.png 150w, https://imagizer.imageshack.com/v2/280x200q70/924/Ia2nWi.png 280w, https://imagizer.imageshack.com/v2/320x240q70/924/Ia2nWi.png 320w, https://imagizer.imageshack.com/v2/640x480q70/924/Ia2nWi.png 640w, https://imagizer.imageshack.com/v2/800x600q70/924/Ia2nWi.png 800w, https://imagizer.imageshack.com/v2/1024x768q70/924/Ia2nWi.png 1024w, https://imagizer.imageshack.com/v2/1280x1024q70/924/Ia2nWi.png 1280w, https://imagizer.imageshack.com/v2/1600x1200q70/924/Ia2nWi.png 1600w" src="https://imagizer.imageshack.com/v2/924/Ia2nWi.png" class="_img_5u372_2 _img_iqejw_34" loading="lazy"></div></article><article class="d-flex flex-column align-items-stretch rounded flex-sm-row _card_iqejw_2 mt-3"><div class="order-sm-1 px-sm-4 d-flex flex-column flex-grow-1 px-3 py-3 order-2"><div class="_content_iqejw_30"><h4 class="_title_iqejw_30 text-body text-line-2">部落格Nuxt 2升級Nuxt 3（四）：PWA模組 @nuxt/pwa → @vite-pwa/nuxt</h4><p class="_description_iqejw_24 text-muted text-line-2" title="在紀錄了最重要的Nuxt Content升級過程之後，接著是 PWA 模組。">在紀錄了最重要的Nuxt Content升級過程之後，接著是 PWA 模組。</p></div><div class="mt-sm-3 d-flex flex-row align-items-center"><time class="d-flex align-items-center flex-row text-muted small mb-0 small"><!--[--><i class="bi-calendar-event me-1"></i><span class="me-3">2024/01/24</span><!--]--></time><span class="text-muted small d-inline-flex align-items-center"><i class="bi-clock me-1"></i><span class="me-3">1 min</span></span><!----><div class="text-end flex-grow-1"><a href="/blog/nuxt2_to_nuxt3_blog_4_modules_pwa/" class="btn-primary btn-sm btn d-inline-flex flex-row align-items-center _btn_1w7mw_2"><!--[--><!--[--> 閱讀更多 <!--]--><i class="bi-arrow-right _icon_1w7mw_2"></i><!--]--></a></div></div></div><div class="position-relative align-self-stretch order-1 order-sm-2 _banner_iqejw_20"><img srcset="https://imagizer.imageshack.com/v2/100x75q70/924/Ia2nWi.png 100w, https://imagizer.imageshack.com/v2/150x100q70/924/Ia2nWi.png 150w, https://imagizer.imageshack.com/v2/280x200q70/924/Ia2nWi.png 280w, https://imagizer.imageshack.com/v2/320x240q70/924/Ia2nWi.png 320w, https://imagizer.imageshack.com/v2/640x480q70/924/Ia2nWi.png 640w, https://imagizer.imageshack.com/v2/800x600q70/924/Ia2nWi.png 800w, https://imagizer.imageshack.com/v2/1024x768q70/924/Ia2nWi.png 1024w, https://imagizer.imageshack.com/v2/1280x1024q70/924/Ia2nWi.png 1280w, https://imagizer.imageshack.com/v2/1600x1200q70/924/Ia2nWi.png 1600w" src="https://imagizer.imageshack.com/v2/924/Ia2nWi.png" class="_img_5u372_2 _img_iqejw_34" loading="lazy"></div></article><article class="d-flex flex-column align-items-stretch rounded flex-sm-row _card_iqejw_2 mt-3"><div class="order-sm-1 px-sm-4 d-flex flex-column flex-grow-1 px-3 py-3 order-2"><div class="_content_iqejw_30"><h4 class="_title_iqejw_30 text-body text-line-2">部落格Nuxt 2升級Nuxt 3（三）：Nuxt Content v1 → v2</h4><p class="_description_iqejw_24 text-muted text-line-2" title="在初步修改非模組的設定值之後，接著就要開始著手模組的升級，這部份是連同改寫為 composition api 一起做的，畢竟不可能只升級特定模組的用法而不去動到其他程式碼，但為了讓文章閱讀容易，就還是分模組來紀錄。">在初步修改非模組的設定值之後，接著就要開始著手模組的升級，這部份是連同改寫為 composition api 一起做的，畢竟不可能只升級特定模組的用法而不去動到其他程式碼，但為了讓文章閱讀容易，就還是分模組來紀錄。</p></div><div class="mt-sm-3 d-flex flex-row align-items-center"><time class="d-flex align-items-center flex-row text-muted small mb-0 small"><!--[--><i class="bi-calendar-event me-1"></i><span class="me-3">2024/01/24</span><!--]--></time><span class="text-muted small d-inline-flex align-items-center"><i class="bi-clock me-1"></i><span class="me-3">7 min</span></span><!----><div class="text-end flex-grow-1"><a href="/blog/nuxt2_to_nuxt3_blog_3_modules_content/" class="btn-primary btn-sm btn d-inline-flex flex-row align-items-center _btn_1w7mw_2"><!--[--><!--[--> 閱讀更多 <!--]--><i class="bi-arrow-right _icon_1w7mw_2"></i><!--]--></a></div></div></div><div class="position-relative align-self-stretch order-1 order-sm-2 _banner_iqejw_20"><img srcset="https://imagizer.imageshack.com/v2/100x75q70/924/Ia2nWi.png 100w, https://imagizer.imageshack.com/v2/150x100q70/924/Ia2nWi.png 150w, https://imagizer.imageshack.com/v2/280x200q70/924/Ia2nWi.png 280w, https://imagizer.imageshack.com/v2/320x240q70/924/Ia2nWi.png 320w, https://imagizer.imageshack.com/v2/640x480q70/924/Ia2nWi.png 640w, https://imagizer.imageshack.com/v2/800x600q70/924/Ia2nWi.png 800w, https://imagizer.imageshack.com/v2/1024x768q70/924/Ia2nWi.png 1024w, https://imagizer.imageshack.com/v2/1280x1024q70/924/Ia2nWi.png 1280w, https://imagizer.imageshack.com/v2/1600x1200q70/924/Ia2nWi.png 1600w" src="https://imagizer.imageshack.com/v2/924/Ia2nWi.png" class="_img_5u372_2 _img_iqejw_34" loading="lazy"></div></article><!--]--></div></div><!--]--><!--]--></main><footer class="pb-5 _footer_4zxf0_2 mt-4"><div class="container container-sm text-white"><!--[--><div class="row"><!--[--><div class="col-sm-4 col-12 mt-5"><!--[--><div class="fw-bold mb-2 d-flex align-items-center h6 text-primary"><!--[--><a href="/blog/buy_me_a_tea#%E9%97%9C%E6%96%BC%E6%88%91" class="text-primary">關於我</a><!--[--><img src="/blog/pwa-64x64.png" height="16" width="16" class="common-icon rounded-circle shadow-sm ms-2"><!--]--><!--]--></div><div class="small"><!--[--><!--[--> 工作時若不喝上一杯飲料就無法做事的前端小碼農。三大前端框架陣營中屬於 Vue 陣營。 <!--]--><!--]--></div><!--]--></div><div class="col-sm-4 col-12 mt-5"><!--[--><div class="fw-bold mb-2 d-flex align-items-center h6 text-primary"><!--[--><a href="/blog/buy_me_a_tea#%E9%97%9C%E6%96%BC%E9%9A%A8%E6%A9%9F%E6%89%8B%E6%9C%AD" class="text-primary">關於隨機手札</a><!--[--><!--]--><!--]--></div><div class="small"><!--[--><!--[--> 使用 <a href="https://v2.nuxt.com/" target="_blank" rel="noopener noreferrer " class="text-white"><!--[--><!--[--> Nuxt 2 <!--]--><!--]--></a> 建置於 <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer " class="text-white"><!--[--><!--[--> Github Pages <!--]--><!--]--></a> 上，全站文字皆在 <a href="https://creativecommons.org/licenses/by-nd/4.0/legalcode.zh-hant" target="_blank" rel="noopener noreferrer " class="text-white"><!--[--><!--[--> 創用CC BY-ND 4.0 條款 <!--]--><!--]--></a> 下提供。 <!--]--><!--]--></div><!--]--></div><div class="col-sm-4 col-12 mt-5"><!--[--><div class="fw-bold mb-2 d-flex align-items-center h6 text-primary"><!--[--><a href="/blog/buy_me_a_tea#%E8%AB%8B%E6%88%91%E5%96%9D%E6%9D%AF%E6%89%8B%E6%90%96%E9%A3%B2%E5%90%A7%EF%BC%81" class="text-primary">請我喝杯手搖飲吧！</a><!--[--><!--]--><!--]--></div><div class="small"><!--[--><!--[--> 若這裡的經驗分享有幫助到你，可以透過<a href="https://ko-fi.com/chaoschaoshuang" target="_blank" rel="noopener noreferrer " class="text-white"><!--[--><!--[--> Ko-fi <!--]--><!--]--></a>請我喝杯手搖飲哦！ <!--]--><!--]--></div><!--]--></div><!--]--></div><!--]--></div></footer><!--]--><!--teleport start--><!--teleport end--><!--]--></div><script type="application/json" id="__NUXT_DATA__" data-ssr="true" data-src="/blog/nuxt2_to_nuxt3_blog_6_modules_pinia/_payload.json">[{"state":1,"once":7,"_errors":9,"serverRendered":12,"path":13,"pinia":14,"prerenderedAt":42},["Reactive",2],{"$ssite-config":3},{"env":4,"name":5,"url":6},"production","blog","https://huangchingchieh.github.io",["Reactive",8],["Set"],["Reactive",10],{"search:":11,"nuxt2_to_nuxt3_blog_6_modules_pinia":11,"titleMap":11,"titleMap:":11,"articles":11},null,true,"/nuxt2_to_nuxt3_blog_6_modules_pinia/",["Reactive",15],{"main":16,"theme":41},{"tagsObj":17,"categories":18,"articlesMetadata":29,"toc":30},{},{"life":19,"frontend":22,"linux":24,"all":26},{"count":20,"pageCount":21},12,2,{"count":23,"pageCount":21},14,{"count":25,"pageCount":21},15,{"count":27,"pageCount":28},41,5,{"count":27,"pageCount":28},[31,33,36,39],{"id":32,"depth":21,"text":32},"寫法差異",{"id":34,"depth":21,"text":35},"實作-nuxtserverinit","實作 nuxtServerInit",{"id":37,"depth":21,"text":38},"在-ssr-端修改-state-的眉角","在 SSR 端修改 state 的眉角",{"id":40,"depth":21,"text":40},"後記",{"dark":11,"preferDark":12},1707809358290]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{base:"/blog/",imageServer:"https://imagizer.imageshack.com/v2/",appHost:"https://huangchingchieh.github.io/blog/",perPage:10,categoriesMap:{all:"最新文章",linux:"Linux心得",frontend:"前端筆記",life:"生活雜記"},description:"一個非本科系的前端小碼農，紀錄一些身為前端小碼農的技術筆記、使用Linux（主要是Fedora）的心得，以及生活上雜七雜八的事情。",isDev:false,mdc:{components:{prose:true,map:{p:"prose-p",a:"ArticleOuterLink",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr",pre:"ArticleCode"}},headings:{anchorLinks:{h1:false,h2:false,h3:false,h4:false,h5:false,h6:false}}},content:{locales:[],defaultLocale:"",integrity:1707809336950,experimental:{stripQueryParameters:false,advanceQuery:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"ArticleOuterLink",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr",pre:"ArticleCode"},highlight:{theme:"github-dark"},wsUrl:"",documentDriven:false,host:"",trailingSlash:false,search:{indexed:true,ignoredTags:["style","code"],filterQuery:{_draft:false,_partial:false},options:{fields:["title","content","titles"],storeFields:["title","content","titles"],searchOptions:{prefix:true,fuzzy:.2,boost:{title:4,content:2,titles:1}}}},contentHead:true,anchorLinks:false}},app:{baseURL:"/blog/",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>