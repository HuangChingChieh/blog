{"tags":["blog","nuxt","vue","nuxt2","nuxt3","vuex","pinia"],"category":"frontend","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://nuxt.com/docs/getting-started/state-management#using-third-party-libraries","rel":["nofollow"]},"children":[{"type":"text","value":"Nuxt 3 的狀態管理套件從 Nuxt 2 的 Vuex 改成了 Pinia"}]},{"type":"text","value":"，兩者差異不算大，部落格用到的功能也不多。其中比較要注意的就是 Nuxt 3 不再提供"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":"方法，若需要在 server 端初始化一些資料的話，就要透過其他作法來完成。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"本來以為升級起來不會太困難，但踩了個小坑……。"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"寫法差異"},"children":[{"type":"text","value":"寫法差異"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這部份因為滿容易的，這邊僅列出官方文章做個參考紀錄："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://pinia.vuejs.org/ssr/nuxt.html","rel":["nofollow"]},"children":[{"type":"text","value":"Nuxt.js 整合指引"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://pinia.vuejs.org/cookbook/migration-vuex.html","rel":["nofollow"]},"children":[{"type":"text","value":"Migrating from Vuex ≤ 4"}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"實作-nuxtserverinit"},"children":[{"type":"text","value":"實作 nuxtServerInit"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之前在 Nuxt 2 中使用"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"text","value":"，是因為我會在此處先處理並紀錄一些 metada（例如各分類的文章數量與頁數）以供元件使用，Nuxt 3 並無提供此方式，參考網路上文章之後可以透過「只在 server 端執行的"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"plugins"}]},{"type":"text","value":"」來完成："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先在主要的"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"store"}]},{"type":"text","value":"下新增"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"index.js"}]},{"type":"text","value":"："}]},{"type":"element","tag":"pre","props":{"className":"language-js shiki shiki-themes github-dark","code":"import { defineStore } from 'pinia'\n\nimport { getCategories, setPageCount } from '~/utils/getCategories'\nimport getTags from '~/utils/getTags'\n\nexport const useMainStore = defineStore('main', {\n  state: () => ({\n    someState: '',\n  }),\n  actions: {\n    nuxtServerInit() {\n      // 這邊做原本nuxtServerInit要做的事\n    },\n  },\n})\n","filename":"store/index.js","language":"js","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" { defineStore } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" 'pinia'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" { getCategories, setPageCount } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '~/utils/getCategories'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" getTags "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '~/utils/getTags'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" useMainStore"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" defineStore"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"'main'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"  state"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": () "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" ({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    someState: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"''"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  }),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  actions: {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"    nuxtServerInit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"      // 這邊做原本nuxtServerInit要做的事\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"})\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接著新增只在 server 端執行的 plugin，可以在命名後加上後綴字"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".server.js"}]},{"type":"text","value":"來標明："}]},{"type":"element","tag":"pre","props":{"className":"language-js shiki shiki-themes github-dark","code":"import { useMainStore } from '~/store'\n\nexport default defineNuxtPlugin(async ({ $pinia }) => {\n  const someAsyncData = await someAsyncFn()\n\n  // 這邊引用前段宣告的store，記得要把context的$pinia傳進去。\n  // 可參考：https://pinia.vuejs.org/ssr/nuxt.html#Awaiting-for-actions-in-pages\n  const mainStore = useMainStore($pinia)\n  mainStore.nuxtServerInit()\n})\n","filename":"plugins/init.server.js","language":"js","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" { useMainStore } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '~/store'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" defineNuxtPlugin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" ({ "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#FFAB70"},"children":[{"type":"text","value":"$pinia"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" }) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" someAsyncData"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" someAsyncFn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"  // 這邊引用前段宣告的store，記得要把context的$pinia傳進去。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"  // 可參考：https://pinia.vuejs.org/ssr/nuxt.html#Awaiting-for-actions-in-pages\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" mainStore"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" useMainStore"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"($pinia)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  mainStore."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"nuxtServerInit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"})\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這樣就完成囉。"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"在-ssr-端修改-state-的眉角"},"children":[{"type":"text","value":"在 SSR 端修改 state 的眉角"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這中間踩了一個坑，本來以為是 Bug 但其實不是。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"總之是這樣的，我在頁面中去修改了某個在 store 中的屬性，而在 layout 中順序比"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<slot />"}]},{"type":"text","value":"（也就是"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<NuxtPage />"}]},{"type":"text","value":"的置入點）前面的元件，若依賴了這個屬性去做"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"v-if"}]},{"type":"text","value":"的顯示，則會在直接進入頁面時出現"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Hydration node mismatch"}]},{"type":"text","value":"的警告，暗示我 server 端與 client 端的元件長得不一樣（也就是資料不一致）。"}]},{"type":"element","tag":"pre","props":{"className":"language-vue shiki shiki-themes github-dark","code":"<template>\n  <div>\n    <!-- 這裡面有個元素依賴了store的state切換顯示 -->\n    <!-- TestHeader會出現Hydration node mismatch的問題 -->\n    <TestHeader />\n\n    <!-- 我在頁面元件中修改了store的state -->\n    <NuxtPage />\n\n    <!-- 放在NuxtPage後面的TestFooter不會出現同樣問題 -->\n    <TestFooter />\n  </div>\n</template>\n\n<script setup>\nimport TestHeader from '~/components/test-header.vue'\nimport TestFooter from '~/components/test-footer.vue'\n</script>\n","filename":"layouts/default.vue","language":"vue","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"    <!-- 這裡面有個元素依賴了store的state切換顯示 -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"    <!-- TestHeader會出現Hydration node mismatch的問題 -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"TestHeader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"    <!-- 我在頁面元件中修改了store的state -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"NuxtPage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"    <!-- 放在NuxtPage後面的TestFooter不會出現同樣問題 -->\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"TestFooter"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" />\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  </"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"div"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" setup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" TestHeader "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '~/components/test-header.vue'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" TestFooter "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '~/components/test-footer.vue'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"</"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"script"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"幾經測試之後，發現好像是元件解析順序的問題，也在 Nuxt Github 的 Discussions 裡面有發現"},{"type":"element","tag":"a","props":{"href":"https://github.com/nuxt/nuxt/discussions/17011","rel":["nofollow"]},"children":[{"type":"text","value":"相關討論"}]},{"type":"text","value":"："}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is a common SSR gotcha. The issue is that on SSR, Vue renders the HTML from top to bottom, outside to inside. And if you only fetch some data as you are rendering the 'inner' part of the page, it doesn't rerender the layout at the top of the page. (On client-side it's fine as can be reactive.) So if you have a common piece you rely on for rendering your page, make sure to fetch it in the layout, a plugin, or a middleware - somewhere outside of the rendering process."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"沒錯，如 Nuxt 團隊的領導人所說：這是一個「common SSR gotcha」（常見的 SSR 問題），無法被解決，只能在開發時自己小心了（是說 Nuxt 2 沒這問題呀……還是只是沒 WARN 而已？）。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"目前因為是 SEO 不敏感的區塊所以還好，解法是直接先把那一個區塊用"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"<ClientOnly>"}]},{"type":"text","value":"包起來，只是未來若遇到這樣的情境，而區塊剛好是 SEO 敏感的區塊……可能就要想想怎麼做了。"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"後記"},"children":[{"type":"text","value":"後記"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"大概是這樣，只能說 Nuxt 2 升 3 的坑其實不少啊……（顯示為精疲力盡）。"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"寫法差異","depth":2,"text":"寫法差異"},{"id":"實作-nuxtserverinit","depth":2,"text":"實作 nuxtServerInit"},{"id":"在-ssr-端修改-state-的眉角","depth":2,"text":"在 SSR 端修改 state 的眉角"},{"id":"後記","depth":2,"text":"後記"}]}}}